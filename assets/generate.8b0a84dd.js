(function(){"use strict";class x{constructor(o,t=!0){this.tiles=o,this.difficulty=0,this.notes=[],t&&(this.notes=this.makeNotes())}getTile(o,t){let e=null;return this.tiles.forEach(r=>{r.row==o&&r.column==t&&(e=r)}),e}getCell(o){let t=[];return this.tiles.forEach(e=>{e.cell==o&&t.push(e)}),t}getRow(o){let t=[];for(let e=1;e<10;e++)t.push(this.getTile(o,e));return t}getColumn(o){let t=[];for(let e=1;e<10;e++)t.push(this.getTile(e,o));return t}makeNotes(){let o=[],t=729,e=81*9-1,r=1,i=[0,0];for(o=this.interpretNotes1(this.gatherNotes(o));r>0;)o=this.interpretNotes1(o),e=this.countPossibilities(o),r=t-e,i[0]+=r,r==0&&(o=this.interpretNotes2(o),r=e-this.countPossibilities(o),i[1]+=r),t=e;return t==0?this.difficulty=this.calcDifficulty(i[0],i[1]):this.difficulty=-1,o}calcDifficulty(o,t){return Math.round((o+100*t)/(o+t))}countPossibilities(o){let t=0;return o.forEach(e=>{e.notes.length>1&&(t+=e.notes.length-1)}),t}gatherNotes(o){let t=[];for(let e=0;e<9;e++)t.push(this.getCell(e));return t.forEach(e=>{e.forEach(r=>{typeof r.index!="number"&&o.push({cell:r.cell,row:r.row,column:r.column,notes:this.missing(e)})})}),o}interpretNotes1(o){let t=[];for(let l=1;l<10;l++)t.push(this.getRow(l));t.forEach((l,f)=>{let c=[];l.forEach(s=>{typeof s.index=="number"&&c.push(s.index)}),o.forEach(s=>{c.forEach(u=>{s.row==f+1&&s.notes.indexOf(u)>-1&&s.notes.splice(s.notes.indexOf(u),1)})})});let e=[];for(let l=1;l<10;l++)e.push(this.getColumn(l));e.forEach((l,f)=>{let c=[];l.forEach(s=>{typeof s.index=="number"&&c.push(s.index)}),o.forEach(s=>{c.forEach(u=>{s.column==f+1&&s.notes.indexOf(u)>-1&&s.notes.splice(s.notes.indexOf(u),1)})})});let r=[1,2,3,4,5,6,7,8,9],i=[];return r.forEach(l=>{let f=this.notesCol(o,l);f.forEach(c=>{c.notes.forEach(s=>{this.unique(f,s)&&i.push({cell:c.cell,row:c.row,column:c.column,index:s})})})}),r.forEach(l=>{let f=this.notesRow(o,l);f.forEach(c=>{c.notes.forEach(s=>{this.unique(f,s)&&i.push({cell:c.cell,row:c.row,column:c.column,index:s})})})}),i.forEach(l=>{this.unsetOthers(o,l)}),this.found(o).forEach(l=>{let f=this.notesRow(o,l.row);f.forEach(c=>{l.column!=c.column&&this.removeFromArray(c.notes,l.notes)}),f=this.notesCol(o,l.column),f.forEach(c=>{l.row!=c.row&&this.removeFromArray(c.notes,l.notes)})}),o}interpretNotes2(o){if(this.pass>0)return o;for(let t=1;t<10;t++){let e=this.notesCell(o.concat(),t-1),r=this.characteristics(e);e=this.addIndexToNotes(e,2,t-1),this.found(e).length<9&&r.forEach(i=>{i.col,i.row}),e=this.notesRow(o.concat(),t),r=this.characteristics(e),e=this.addIndexToNotes(e,0,t),this.found(e).length<9&&r.forEach(i=>{i.cell}),e=this.notesCol(o.concat(),t),r=this.characteristics(e),e=this.addIndexToNotes(e,1,t),this.found(e).length<9&&r.forEach(i=>{i.cell}),e=this.notesCell(o.concat(),t-1),r=[],r=this.threeTwoTwo(e),r.length>0&&this.found(e).length<9&&r.forEach(i=>{this.removeFromCell(o,i.row,i.column,i.cell,i.notes)})}for(let t=1;t<10;t++)for(let e=0;e<9;e++){let r=this.notesCell(o,t),i=this.findDigitInNotes(r,e);i.length==1&&(i[0].notes=[e])}return o}isValid(o){let t=!0;return o.forEach(e=>{let r=this.getTile(e.row,e.column);e.notes.length==0&&typeof r.index!="number"&&(t=!1)}),t}unsetCell(o){this.getCell(o).forEach(e=>{e.index=""})}setCell(o){let t=this.getCell(o),e=[0,1,2,3,4,5,6,7,8],r=[],i=-1,n=0;n=0;let l=0;for(r=e.concat();r.length>0&&typeof t[n]!="undefined"&&l<200;)if(i=Math.round(Math.random()*(r.length-1)),l++,typeof r[i]!="undefined"&&this.isPossible(t[n],r[i],this.makeNotes())){let f=t[n++];f.index=r[i],r.splice(i,1)}return l<200}removeIndex(){let o=-1,t=-1,e=null,r="";for(;;)if(o=Math.round(Math.random()*8)+1,t=Math.round(Math.random()*8)+1,e=this.getTile(o,t),r="",typeof e.index=="number"){r=e.index,e.index="";break}return{row:o,col:t,index:r}}makeHints(o,t){let e=[],r=!0;for(let i=0;i<o;i++)e.push(this.removeIndex());return this.makeNotes(),(this.difficulty>t+.5||this.difficulty<t)&&e.forEach(i=>{let n=this.getTile(i.row,i.col);n.index=i.index,r=!1}),r}generate(o=1){for(let n=0;n<9;n++)this.unsetCell(n);let t=0,e=0;for(let n=0;n<9;n++)for(t=0;!this.setCell(n)&&t++<200;)this.unsetCell(n);let r=[28,26,24,22],i=81-r[o-1];for(;e++<200&&!this.makeHints(i,o););return e>198&&this.generate(o),this.tiles.forEach(n=>{typeof n.index=="number"&&(n.initialValue=!0)}),this.tiles}getNote(o,t,e){let r=null;return o.forEach(i=>{i.row==t&&i.column==e&&(r=i)}),r}isPossible(o,t,e){return this.getNote(e,o.row,o.column).notes.indexOf(t)>-1}addIndexToNotes(o,t,e){let r=[];return this.tiles.forEach(i=>{typeof i.index=="number"&&(t==0&&e==i.row||t==1&&e==i.column||t==2&&e==i.cell)&&(i.notes=[i.index],r.push(i))}),o.concat(r)}notesCell(o,t){let e=[];return o.forEach(r=>{r.cell==t&&(e=e.concat(r))}),e}notesRow(o,t){let e=[];return o.forEach(r=>{r.row==t&&(e=e.concat(r))}),e}notesCol(o,t){let e=[];return o.forEach(r=>{r.column==t&&(e=e.concat(r))}),e}unsetOthers(o,t){o.forEach(e=>{e.row==t.row&&e.column==t.column?e.notes=[t.index]:(t.cell==e.cell&&e.notes.indexOf(t.index)>-1||t.row==e.row&&e.notes.indexOf(t.index)>-1||t.row==e.row&&e.notes.indexOf(t.index)>-1)&&e.notes.splice(e.notes.indexOf(t.index),1)})}allOnRow(o){let t=null;return o.forEach(e=>{e.notes.forEach(r=>{typeof t=="object"?t=e.row:t!=e.row?t=-1:t>-1&&(t=e.row)})}),typeof t=="object"?-1:t}allOnColumn(o){let t=null;return o.forEach(e=>{e.notes.forEach(r=>{typeof t=="object"?t=e.column:t!=e.column?t=-1:t>-1&&(t=e.column)})}),typeof t=="object"?-1:t}findDigitInNotes(o,t){let e=[];return o.forEach(r=>{r.notes.indexOf(t)>-1&&e.push(r)}),e}findIndentical(o){let t=[];return o.forEach((e,r)=>{o.forEach((i,n)=>{this.identical(e.notes,i.notes)&&n<r&&!this.contains(t,e)&&(t.push(e),t.push(i))})}),t}contains(o,t){return typeof o.find(r=>{if(r.row==t.row&&r.column==t.column)return r})!="undefined"}found(o){let t=[];return o.forEach(e=>{e.notes.length==1&&t.push(e)}),t}found2(o){let t=[];return o.forEach(e=>{t.push(e.notes)}),t}missing(o){let t=[0,1,2,3,4,5,6,7,8];return o.forEach(e=>{typeof e.index=="number"&&t.splice(t.indexOf(e.index),1)}),t}occurences(o,t){let e=0;return o.forEach(r=>{r.notes.forEach(i=>{i===t&&e++})}),e}identical(o,t){let e=[];return o.forEach(r=>{e.push(r)}),t.forEach(r=>{e.indexOf(r)>-1?e.splice(e.indexOf(r),1):e.push(null)}),e.length===0}threeTwoTwo(o){let t=o.concat(),e=[];t.forEach(s=>{s.notes.forEach(u=>{let a=e.findIndex(E=>{if(E.digit==u)return E});a>-1?(e[a].n++,e[a].rows.push(s.row),e[a].columns.push(s.column)):e.push({digit:u,rows:[s.row],columns:[s.column],n:1})})});let r=[],i=[];e.forEach(s=>{s.n==2?r.push(s):s.n==3&&i.push(s)});let n=[],l=[];r.length>0&&(l=l.concat(r)),i.length>0&&(l=l.concat(i)),e.forEach(s=>{n.push(s.digit)}),t=o.concat(),n=[],l.length==3&&l.forEach(s=>{n.push(s)});let f=[];if([].concat(r,i).forEach(s=>{s.rows.forEach((u,a)=>{f.find(h=>{if(h.row==s.rows[a]&&h.column==s.columns[a])return h})||f.push({row:s.rows[a],column:s.columns[a]})})}),f.length==3&&r.length==2&&i.length==1){let s=null,u=null,a=null;i.forEach((h,g)=>{let m=null;r.forEach(p=>{p.digit==h.digit&&(m=!0)}),m||(s=h.digit,u=h.columns[g],a=h.rows[g])});let E=[];return i.forEach(h=>{h.digit==s&&h.rows.forEach((g,m)=>{let p=o.find(d=>{if(d.row==h.rows[m]&&d.column==h.columns[m])return d});if(p){let d=p.notes.concat();h.rows[m]==a&&h.columns[m]==u?d.splice(d.indexOf(s),1):d=[s],E.push({notes:d,row:p.row,column:p.column,cell:p.cell})}})}),E}return[]}characteristics(o){let t=[0,1,2,3,4,5,6,7,8],e=[];return t.forEach(r=>{let i=[],n=[],l=[];o.forEach(f=>{f.notes.forEach(c=>{i.indexOf(f.row)==-1&&c==r&&i.push(f.row),n.indexOf(f.column)==-1&&c==r&&n.push(f.column),l.indexOf(f.cell)==-1&&c==r&&l.push(f.cell+1)})}),i.length==1&&e.push({index:r,row:i[0]}),n.length==1&&e.push({index:r,col:n[0]}),l.length==1&&e.push({index:r,cell:l[0]})}),e}notTaken(o){let t=[0,1,2,3,4,5,6,7,8];return o.forEach(e=>{typeof e.index=="number"&&t.splice(t.indexOf(e.index),1)}),t}removeFromCell(o,t,e,r,i){o.forEach(n=>{typeof t=="number"?typeof r=="number"?r>0?n.cell!=r-1&&n.row==t&&this.removeFromArray(n.notes,i):n.cell==-1*r-1&&n.row!=t&&this.removeFromArray(n.notes,i):n.row!=t&&this.removeFromArray(n.notes,i):typeof e=="number"&&(typeof r=="number"?r>0?n.cell!=r-1&&n.column==e&&this.removeFromArray(n.notes,i):n.cell==-1*r-1&&n.column!=e&&this.removeFromArray(n.notes,i):n.column!=e&&this.removeFromArray(n.notes,i))})}removeFromArray(o,t){t.forEach(e=>{o.indexOf(e)>-1&&o.splice(o.indexOf(e),1)})}unique(o,t){return this.occurences(o,t)===1}uniqueNotes(o){let t=!0;return o.forEach((e,r)=>{o.forEach((i,n)=>{n<r&&this.identical(e.notes,i.notes)&&(t=!1)})}),t}getDifficulty(){return this.isValid(this.notes)?this.difficulty:-1}getNotes(){return this.notes}}var y={sudoku:x};addEventListener("message",w=>{let o=new y.sudoku(w.data.tiles);console.log(o.getDifficulty()),postMessage({tiles:o.generate(w.data.d),d:o.getDifficulty()})})})();
